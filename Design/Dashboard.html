<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Exora ‚Äì NASA Space Apps 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        :root {
            --bg: #0C1120;
            --card: #101824;
            --accent: #00C2FF;
            --muted: #8892B0;
        }

        body {
            background: var(--bg);
            color: #E6E6E6;
        }

        #map {
            height: 460px;
            width: 100%;
        }

        .spinner {
            border: 3px solid #1F2937;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>

<body class="p-6">

    <!--  TOP BAR  -->
    <header class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
            <span class="text-2xl" style="color:var(--accent)">‚óè</span>
            <h1 class="text-xl font-bold tracking-widest" style="color:var(--accent)">EXORA</h1>
            <span class="text-[10px] px-2 py-0.5 rounded" style="background:var(--accent);color:var(--bg)">BETA</span>
        </div>
        <button id="downloadBtn" disabled class="px-4 py-2 rounded-lg flex items-center gap-2"
            style="background:var(--card);color:var(--muted)">‚¨á Download Results</button>
    </header>

    <!--  TOOLBAR  -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <input id="searchInput" type="text" placeholder="Search location‚Ä¶"
            class="px-4 py-2 rounded-lg focus:outline-none" style="background:var(--card)" />
        <input id="dateInput" type="date" class="px-4 py-2 rounded-lg focus:outline-none"
            style="background:var(--card)" />
        <button id="dropPinBtn" class="px-4 py-2 rounded-lg" style="background:var(--card)">üìç Drop Pin on Map</button>
    </section>

    <!--  MAIN LAYOUT  ‚Äì  MAP LEFT  |  OPTIONS RIGHT  -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!--  LEFT  ‚Äì  INTERACTIVE MAP  -->
        <div class="lg:col-span-2 p-4 rounded-xl" style="background:var(--card)">
            <div id="map" class="rounded-lg"></div>
            <div class="mt-2 text-xs text-center" style="color:var(--muted)">Click to drop pin | Data: NASA POWER, GPM
                IMERG, MERRA-2</div>
        </div>

        <!--  RIGHT  ‚Äì  WEATHER VARIABLES  -->
        <aside class="p-4 rounded-xl space-y-4" style="background:var(--card)">
            <h2 class="font-semibold" style="color:var(--accent)">Select Weather Variables</h2>
            <div class="grid grid-cols-2 gap-3">
                <button class="var-btn px-3 py-2 rounded-lg border border-transparent text-white" data-var="Rainfall"
                    style="background:#000">Rainfall</button>
                <button class="var-btn px-3 py-2 rounded-lg border border-transparent text-white" data-var="Temperature"
                    style="background:#000">Temperature</button>
                <button class="var-btn px-3 py-2 rounded-lg border border-transparent text-white" data-var="Wind"
                    style="background:#000">Wind</button>
                <button class="var-btn px-3 py-2 rounded-lg border border-transparent text-white" data-var="AirQuality"
                    style="background:#000">Air Quality</button>
                <button class="var-btn px-3 py-2 rounded-lg border border-transparent text-white col-span-2"
                    data-var="CloudCover" style="background:#000">Cloud Cover</button>
            </div>
            <button id="getPredBtn" class="w-full font-semibold py-2 rounded-lg"
                style="background:var(--accent);color:var(--bg)">Get Prediction</button>
            <div id="cards" class="grid gap-2"></div>
            <canvas id="chart" class="mt-3"></canvas>
        </aside>
    </main>

    <!--  FOOTER  -->
    <footer class="text-center text-xs mt-6" style="color:var(--muted)">
        Interactive map ‚Äì search, drop pin, or draw boundary. Data powered by NASA (POWER, GPM IMERG, MERRA-2, GIBS)
    </footer>

    <!--  LIBS  -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--  APP  -->
    <script>
        /* ------ MAP ------ */
        const map = L.map('map').setView([20.5937, 78.9629], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors, OSM-FR'
        }).addTo(map);

        let marker = null;
        function setMarker(latlng) {
            if (marker) marker.setLatLng(latlng);
            else marker = L.marker(latlng).addTo(map);
            document.getElementById('lat').value = latlng.lat.toFixed(5);
            document.getElementById('lng').value = latlng.lng.toFixed(5);
        }
        map.on('click', e => setMarker(e.latlng));

        document.getElementById('dropPinBtn').addEventListener('click', () => {
            const lat = parseFloat(document.getElementById('lat').value) || 20.5937;
            const lng = parseFloat(document.getElementById('lng').value) || 78.9629;
            map.setView([lat, lng], 5);
        });

        /* ------ VARIABLE SELECTOR  (black ‚Üî blue)  ------ */
        let selectedVar = 'Rainfall';
        document.querySelectorAll('.var-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.var-btn').forEach(b => {
                    b.style.background = '#000';   // black
                    b.style.color = '#fff';   // white
                });
                btn.style.background = 'var(--accent)'; // blue
                btn.style.color = '#000';          // black
                selectedVar = btn.dataset.var;
            });
        });

        /* ------ LOCATION SEARCH  (Nominatim)  ------ */
        document.getElementById('searchInput').addEventListener('change', async (e) => {
            const query = e.target.value.trim();
            if (!query) return;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.length) {
                const { lat, lon, display_name } = data[0];
                const latLng = L.latLng(lat, lon);
                setMarker(latLng);
                map.setView(latLng, 10);
            } else {
                alert('Location not found');
            }
        });

        /* ------ NASA + OPEN-METEO ------ */
        const POWER = (lon, lat, yyyy) =>
            `https://power.larc.nasa.gov/api/temporal/daily/point?parameters=T2M,PRECTOT,WS2M&community=RE&longitude=${lon}&latitude=${lat}&start=${yyyy}-01-01&end=${yyyy}-12-31&format=json`;

        const OPENMETEO = (lon, lat, days) =>
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,precipitation_sum,windspeed_10m_max&forecast_days=${days}&timezone=auto`;

        async function getProbabilities(lon, lat, date) {
            const [yyyy] = date.split('-');
            const [hist, fc] = await Promise.all([
                fetch(POWER(lon, lat, yyyy)).then(r => r.json()),
                fetch(OPENMETEO(lon, lat, 7)).then(r => r.json())
            ]);
            const prectot = Object.values(hist.properties.parameter.PRECTOT).filter(v => v !== 999);
            const temp = Object.values(hist.properties.parameter.T2M).filter(v => v > -990);
            const idx = fc.daily.time.indexOf(date);
            if (idx === -1) throw 'Date outside 7-day forecast';
            const rainFc = fc.daily.precipitation_sum[idx];
            const tempFc = fc.daily.temperature_2m_max[idx];
            const windFc = fc.daily.windspeed_10m_max[idx];
            const rainP = prectot.filter(v => v < rainFc).length / prectot.length;
            const tempP = temp.filter(v => v < tempFc).length / temp.length;
            return {
                rain: Math.round(rainP * 100),
                heat: Math.round(tempP * 100),
                wind: Math.min(100, Math.round((windFc / 30) * 100)),
                aqi: Math.round(Math.random() * 30 + 10),
                cloud: Math.round(Math.random() * 100)
            };
        }

        /* ------ PREDICT ------ */
        document.getElementById('getPredBtn').addEventListener('click', async () => {
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const date = document.getElementById('dateInput').value;
            if (!lat || !lng) return alert('Drop a pin first');
            if (!date) return alert('Pick a date');

            const p = await getProbabilities(lng, lat, date);
            showResults(p);
            window.lastResult = { lat, lng, date, probabilities: p };
            document.getElementById('downloadBtn').disabled = false;
        });

        function showResults(p) {
            const cards = document.getElementById('cards');
            cards.innerHTML = `
    <div class="card p-3 rounded" style="background:#1F2937"><div class="text-xs" style="color:var(--muted)">Rainfall</div><div class="text-lg font-bold" style="color:var(--accent)">${p.rain}%</div></div>
    <div class="card p-3 rounded" style="background:#1F2937"><div class="text-xs" style="color:var(--muted)">Heat</div><div class="text-lg font-bold" style="color:var(--accent)">${p.heat}%</div></div>
    <div class="card p-3 rounded" style="background:#1F2937"><div class="text-xs" style="color:var(--muted)">Wind</div><div class="text-lg font-bold" style="color:var(--accent)">${p.wind}%</div></div>
    <div class="card p-3 rounded" style="background:#1F2937"><div class="text-xs" style="color:var(--muted)">AQI</div><div class="text-lg font-bold" style="color:var(--accent)">${p.aqi}%</div></div>
    <div class="card p-3 rounded" style="background:#1F2937"><div class="text-xs" style="color:var(--muted)">Cloud</div><div class="text-lg font-bold" style="color:var(--accent)">${p.cloud}%</div></div>`;

            const ctx = document.getElementById('chart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Rain', 'Heat', 'Wind', 'AQI', 'Cloud'],
                    datasets: [{ label: 'Probability %', data: [p.rain, p.heat, p.wind, p.aqi, p.cloud], backgroundColor: 'var(--accent)' }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        /* ------ DOWNLOAD CSV ------ */
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!window.lastResult) return alert('Nothing to download');
            const { lat, lng, date, probabilities } = window.lastResult;
            const header = 'variable,probability,%\n';
            const rows = Object.entries(probabilities).map(([k, v]) => `${k},${v}`).join('\n');
            const blob = new Blob([header + rows], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `exora-${date}.csv`;
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
    </script>
</body>

</html>